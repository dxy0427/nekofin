name: Nightly Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  get-commit-info:
    name: Get Commit Info
    runs-on: ubuntu-latest
    outputs:
      sha_short: ${{ steps.commit.outputs.sha_short }}
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get commit SHA
        id: commit
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Check commit message
        id: check
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            if [[ "$COMMIT_MSG" =~ ^(ci|docs)(\(.+\))?: ]]; then
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "Skipping build for commit message: $COMMIT_MSG"
            else
              echo "should_build=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  call-build-workflow:
    name: Call Build Apps Workflow
    needs: get-commit-info
    if: needs.get-commit-info.outputs.should_build == 'true'
    uses: ./.github/workflows/build-apps.yml
    with:
      platform: both
      android_profile: production
      ios_build_type: release
      build_suffix: _nightly-${{ needs.get-commit-info.outputs.sha_short }}
    secrets: inherit

  upload-to-release:
    name: Upload to Pre-release
    needs: [get-commit-info, call-build-workflow]
    runs-on: ubuntu-latest
    if: needs.get-commit-info.outputs.should_build == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-release-main_nightly-${{ needs.get-commit-info.outputs.sha_short }}
          path: ./artifacts/android

      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-release-main_nightly-${{ needs.get-commit-info.outputs.sha_short }}
          path: ./artifacts/ios

      - name: Get commit message
        id: commit_msg
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            COMMIT_MSG="${{ github.event.head_commit.message }}"
          else
            COMMIT_MSG="Manual trigger"
          fi
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Delete old release assets
        run: |
          if gh release view nightly > /dev/null 2>&1; then
            echo "Found existing nightly release, deleting old assets..."
            gh release view nightly --json assets --jq '.assets[].name' | while read asset; do
              echo "Deleting asset: $asset"
              gh release delete-asset nightly "$asset" -y || true
            done
          else
            echo "No existing nightly release found"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create or update pre-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly
          name: Nightly Build
          body: |
            ## Nightly Build - ${{ needs.get-commit-info.outputs.sha_short }}

            **Commit Message:**
            ${{ steps.commit_msg.outputs.message }}

            **Build Date:** ${{ github.event.head_commit.timestamp }}
          files: |
            ./artifacts/android/*.apk
            ./artifacts/ios/*.ipa
          prerelease: true
          draft: false
          token: ${{ secrets.GITHUB_TOKEN }}
